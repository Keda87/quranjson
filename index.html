<html>
	<head>
		<title>Quran JSON</title>
		<link href="/quranjson/booklet/jquery.booklet.latest.css" type="text/css" rel="stylesheet" media="screen, projection, tv" />
		<link href="/quranjson/jquery-loading/jquery.loading.min.css" type="text/css" rel="stylesheet" />
		<style>
			body{
				background:#f5f0ed;
			}
			#quran{
				display:none;
			}
		</style>
		<script src="/quranjson/js/jquery-1.10.2.min.js"></script>
		<script src="/quranjson/js/jquery.storageapi.min.js"></script>
		<script src="/quranjson/booklet/jquery.easing.1.3.js"></script>
		<script src="/quranjson/booklet/jquery.booklet.latest.min.js"></script>
		<script src="/quranjson/jquery-loading/jquery.loading.min.js"></script>
		<script>
			$(document).ready(function(){
				var bases = '/quranjson/surah/';
				var storg = $.localStorage;
				var surah = undefined;
				var pages = undefined;
				
				var dofail = function(){
					console.log('fail!');
					surah = undefined;
					$('#quran').empty();
				};
				var dones = function(){
					console.log('done..');
					if( surah != undefined && pages != undefined ){
						$('#quran').booklet({
							width:$(window).width() / 1.05,
							height:$(window).height() / 1.05,
							direction:  'RTL',
							manual: false,
							overlays:true,
							hash: true,
							change: function( event, data){
								storg.set( 'current', data.index );
							} 
						});
						$('#quran').show();
						if( !storg.isEmpty( 'current' ) ){
							$('#quran').booklet("gotopage", storg.get('current') );
						};
						$('body').loading('stop');
					};
				};
				var loads = function( ip ){
					if( pages[ ip ] == undefined && ip < pages.length ){
						ip += 1;
						loads( ip );
					}else{
						if( ip < pages.length ){
							var percent = Math.floor( ( ip / pages.length ) * ( 100/ 100 ) * 100 + 1 );
							$('.loading-overlay-content').html('Loading Page ' + percent + '%<br/><br/><small>Scripted by {Semar::Ketir};</small>');
							$.ajax({
								type: "GET",
								cache: true,
								url: bases + pages[ ip ],
								dataType: 'json',
							}).done(function( data ) {
								var temp = $.map( surah.pages,function(val,ind){
									if( val == pages[ ip ] ){
										return ind;
									};
								}).toString();
								if( temp.length > 0 ){
									$('#quran').append([
										'<div>',
											'<img src="'+data[temp]+'" width="100%" height="100%" />',
										'</div>'
									].join(''));
								};
								ip += 1;
								if( ip < pages.length ){
									loads( ip );
								}else{
									dones();
								};
							}).fail(function(){
								dofail();
							});
						}else{
							dones();
						};
					};
				};
				
				if( storg.isEmpty( 'surah' ) ){
					$.ajax({
						type: "GET",
						cache: true,
						url: bases + 'surah.json',
						dataType: 'json',
					}).done(function( data ) {
						if( data['pages'] && data['surah'] ){
							surah = data;
							pages = $.map( surah.pages,function(val,ind){
								return val;
							});
							storg.set( 'surah', JSON.stringify( surah ) );
							storg.set( 'pages', JSON.stringify( pages ) );
							loads( 0 );
						}else{
							dofail();
						};
					}).fail(function(){
						dofail();
					});
				}else{
					surah = ( $.type( storg.get( 'surah' ) ) == 'string' ? JSON.parse( storg.get( 'surah' ) ) : storg.get( 'surah' ) );
					pages = ( $.type( storg.get( 'pages' ) ) == 'string' ? JSON.parse( storg.get( 'pages' ) ) : storg.get( 'pages' ) );
					loads( 0 );
				};
				
				$('body').loading({
					stoppable: false,
					message:'Loading Surah...<br/><br/><small>Scripted by {Semar::Ketir};</small>'
				});
			});
		</script>
	</head>
	<body>
		<div id="quran"></div>
	</body>
</html>